<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Countdown control</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/slate.min.css">
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/bootstrap-slider/dist/css/bootstrap-slider.css"></script>
  <script src="node_modules/bootstrap-slider/dist/bootstrap-slider.js"></script>
</head>
<script>
    function init() {
      var ws = new WebSocket("ws://" + location.host + ":5678");
      ws.onopen = function(mess) {
          // This way the protocol will always try to send
          // data through websockets.
          ws.send("/?SET_PORT=0");
          ws.send("/color");
          ws.send("/speed");
          ws.send("/brightness");
          ws.send("/text");
          ws.send("/play");
      }
      var play = document.getElementById('play');
      var color = document.getElementById('color');
      var speed = document.getElementById('speed');
      var brightness = document.getElementById('brightness');
      var text = document.getElementById('text');
      var speed_nbx = document.getElementById('speed_nbx');
      var brighness_nbx = document.getElementById('brighness_nbx');

      ws.onmessage = function(mess) {
          // An OSCQuery value json looks like
          // { "/the/addr" : 123 }
          console.log(mess.data);
          var json = JSON.parse(mess.data);
          var keys = Object.keys(json);

          var play_k = keys.findIndex(function(val) { return val == "/play"; });
          var color_k = keys.findIndex(function(val) { return val == "/color"; });
          var speed_k = keys.findIndex(function(val) { return val == "/speed"; });
          var brightness_k = keys.findIndex(function(val) { return val == "/brightness"; });
          var text_k = keys.findIndex(function(val) { return val == "/text"; });
          var full_path_k = keys.findIndex(function(val) { return val == "FULL_PATH"; });
          if(color_k != -1)
          {
              color.value = rgbToHex(json["/color"][0],json["/color"][1],json["/color"][2]);
          }
          if(speed_k != -1)
          {
              speed.value = json["/speed"] * 100;
          }
          if(brightness_k != -1)
          {
              brightness.value = json["/brightness"];
          }
          if(play_k != -1)
          {
              play.checked = json["/play"];
          }
          if(text_k != -1)
          {
              text.checked = json["/text"];
          }
          if(full_path_k != -1)
          {
            path = json["FULL_PATH"];
            if (path == "/color")
            {
              color.value = rgbToHex(json["VALUE"][0],json["VALUE"][1],json["VALUE"][2]);
            }
            else if (path == "/speed")
            {
              speed.value = json["VALUE"] * 100;
            }
            else if (path == "/brightness")
            {
              brightness.value = json["VALUE"];
            }
            else if (path == "/play")
            {
              play.checked = json["VALUE"];
            }
            else if (path == "/text")
            {
              text.value = json["VALUE"];
            }
            else
            {
              console.log("please process fullpath " + path)
            }
          }
      }
      speed.oninput = function(ev) {
              var val = speed.value / 100.
              ws.send('{ "/speed": ' + val + '}');
              speed_nbx.value = val;
              console.log('{ "/speed": ' + val + '}');
      };
      brightness.oninput = function(ev) {
              var val = brightness.value
              ws.send('{ "/brightness": ' + val + '}');
              brightness_nbx.value = val;
              console.log('{ "/brightness": ' + val + '}');
      };
      play.oninput = function(ev) {
              ws.send('{ "/play": ' + play.checked + '}');
              console.log('{ "/play": ' + play.checked + '}');
      };
      text.oninput = function(ev) {
              ws.send('{ "/text": "' + text.value + '" }');
              console.log('{ "/text": ' + text.value + '}');
      };
      color.oninput = function(ev) {
              rgb = hexToRGB(color.value);
              ws.send('{ "/color": [' + rgb + ']}');
              console.log('{ "/color": ' + rgb + '}');
      };
      speed_nbx.oninput = function(ev) {
              speed.value = speed_nbx.value * 100;
              console.log('nbx oninput');
      }
      brightness_nbx.oninput = function(ev) {
              brightness.value = brightness_nbx.value;
      }

      // from http://www.javascripter.net/faq/hextorgb.htm
      function hexToRGB(h) {return [ hexToR(h), hexToG(h), hexToB(h) ] }
      function hexToR(h) {return parseInt((cutHex(h)).substring(0,2),16)}
      function hexToG(h) {return parseInt((cutHex(h)).substring(2,4),16)}
      function hexToB(h) {return parseInt((cutHex(h)).substring(4,6),16)}
      function cutHex(h) {return (h.charAt(0)=="#") ? h.substring(1,7):h}

      // from http://www.javascripter.net/faq/rgbtohex.htm
      function rgbToHex(R,G,B) {return '#'+toHex(R)+toHex(G)+toHex(B)}
      function toHex(n) {
       n = parseInt(n,10);
       if (isNaN(n)) return "00";
       n = Math.max(0,Math.min(n,255));
       return "0123456789ABCDEF".charAt((n-n%16)/16)
            + "0123456789ABCDEF".charAt(n%16);
      }

      function test()
      {
        console.log("this is a test");
      }
    }
</script>

<body onload="init()">
<div class="container-fluid">
  <h1>Countdown</h1>
  <h2>Interactive LED countdown</h2>
  <div class="row">
    <div class="col-xs-6"><input id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="20" data-slider-step="1" data-slider-value="14"/></div>
    <div class="col-xs-6"><button type="button" class="btn">Basic</button></div>
  </div>

  <div class="row">
   <div class="col-xs-4">
     Play
   </div>
   <div class="col-xs-8">
    <input id="play"  type="checkbox" oninput="test()"/>
   </div>
  </div>

  <div class="row">
    <div class="col-xs-4">
      Color
    </div>
    <div class="col-xs-8">
      <input id="color" type="color">
    </div>
  </div>

  <div class="row">
    <div class="col-xs-4">
      Speed
    </div>
    <div class="col-xs-6">
      <input id="speed" type="range" min="-200" max="200">
    </div>
    <div class="col-xs-2">
      <input id="speed_nbx" type="number" min="-2" max="2" step="0.01">
    </div>
  </div>

  <div class="row">
    <div class="col-xs-4">
      Brightness
    </div>
    <div class="col-xs-6">
      <input id="brightness" type="range" min="0" max="31">
    </div>
    <div class="col-xs-2">
      <input id="brightness_nbx" type="number" min="0" max="31" step="1">
    </div>
  </div>

  <div class="row">
    <div class="col-xs-4">
      Text
    </div>
    <div class="col-xs-8">
      <input id="text"  type="text"/>
    </div>
  </div>

</div>
</body>

</html>
