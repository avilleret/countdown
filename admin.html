<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Countdown control</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/slate.min.css">
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="node_modules/bootstrap-slider/dist/css/bootstrap-slider.css"></script>
  <script src="node_modules/bootstrap-slider/dist/bootstrap-slider.js"></script>
</head>
<script>
    var ws = new WebSocket("ws://" + location.host + ":5678");

    function init() {
      ws.onopen = function(mess) {
      }
      var play = document.getElementById('play');
      var color = document.getElementById('color');
      var speed = document.getElementById('speed');
      var brightness = document.getElementById('brightness');
      var text = document.getElementById('text');
      var speed_nbx = document.getElementById('speed_nbx');
      var brighness_nbx = document.getElementById('brighness_nbx');
      var time = document.getElementById('time');

      ws.onmessage = function(mess) {
          // An OSCQuery value json looks like
          // { "/the/addr" : 123 }
          //console.log(mess.data);
          var json = JSON.parse(mess.data);
          var keys = Object.keys(json);

          var play_k = keys.findIndex(function(val) { return val == "/play"; });
          var color_k = keys.findIndex(function(val) { return val == "/color"; });
          var speed_k = keys.findIndex(function(val) { return val == "/speed"; });
          var brightness_k = keys.findIndex(function(val) { return val == "/brightness"; });
          var text_k = keys.findIndex(function(val) { return val == "/text"; });
          var blink_k = keys.findIndex(function(val) { return val == "/blink"; });
          var time_k = keys.findIndex(function(val) { return val == "/time"; });

          var full_path_k = keys.findIndex(function(val) { return val == "FULL_PATH"; });

          if(color_k != -1)
          {
              color.value = rgbToHex(json["/color"][0],json["/color"][1],json["/color"][2]);
              time.style.color = color.value
          }
          // if(speed_k != -1)
          // {
          //     speed.value = json["/speed"] * 100;
          // }
          if(brightness_k != -1)
          {
              brightness.value = json["/brightness"];
          }
          if(play_k != -1)
          {
              play.checked = json["/play"];
          }
          if(text_k != -1)
          {
              text.checked = json["/text"];
          }
          if(time_k != -1)
          {
              val = json["/time"];
              minutes = parseInt(val / 60);
              seconds = parseInt(val % 60);
              time.innerText = ( "00" + minutes ).slice(-2) + ":" + ( "00" + seconds).slice(-2);
          }
          if(full_path_k != -1)
          {
            path = json["FULL_PATH"];
            if (path == "/color")
            {
              color.value = rgbToHex(json["VALUE"][0],json["VALUE"][1],json["VALUE"][2]);
              time.style.color = color.value
            }
            else if (path == "/speed")
            {
              speed.value = json["VALUE"] * 100;
            }
            else if (path == "/brightness")
            {
              brightness.value = json["VALUE"];
            }
            else if (path == "/play")
            {
              play.checked = json["VALUE"];
            }
            else if (path == "/text")
            {
              text.value = json["VALUE"];
            }
            else
            {
              console.log(json["VALUE"])
              console.log("please process fullpath " + path)
            }
          }
      }
    }

    function update() {
      ws.send('{ "/admin/update" : ""}');
      //ws.send("/update");
      console.log('{ "/admin/update" }');
    }

    function reboot() {
      ws.send('{ "/admin/reboot" : ""}');
      //ws.send("/update");
      console.log('{ "/admin/reboot" }');
    }

</script>

<body onload="init()">
<div class="container">
  <h1>Countdown</h1>
  <h2>Interactive LED countdown</h2>

  <div class="row">
    <div class="col-xs-12">
      <button onclick="update()">Update</button>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <button onclick="reboot()">Reboot</button>
    </div>
  </div>

  <div class="h1">
  <p id="log"></p>
  </div>

</div>
</body>

</html>
